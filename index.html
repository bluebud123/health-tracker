<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#3B7A6B">
<link rel="manifest" href="./manifest.json">
<title>Health Tracker</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#F7F5F0;max-width:500px;margin:0 auto;overscroll-behavior:none}
input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}
input[type=number]{-moz-appearance:textfield}
.cd{background:#fff;border-radius:16px;padding:18px;box-shadow:0 2px 12px rgba(0,0,0,.06);margin-bottom:14px;border:1px solid #E8E4DC;overflow:hidden}
.ct{font-size:13px;font-weight:700;color:#3B7A6B;margin-bottom:12px;letter-spacing:.5px}
.btn{border:none;border-radius:14px;padding:16px;font-weight:700;cursor:pointer;width:100%;display:flex;align-items:center;justify-content:center;gap:8px;font-size:15px;font-family:inherit}
.bp{background:#3B7A6B;color:#fff;box-shadow:0 4px 14px rgba(59,122,107,.3)}
.bw{background:#25D366;color:#fff;box-shadow:0 4px 14px rgba(37,211,102,.3)}
.be{background:#5A6B8F;color:#fff}
.bo{background:#fff;color:#3B7A6B;border:2px solid #3B7A6B}
.inp{width:100%;padding:12px;border:1.5px solid #E8E4DC;border-radius:10px;outline:none;background:#FAFAF8;font-size:14px;font-family:inherit;box-sizing:border-box}
.inp:focus{border-color:#3B7A6B}
.inp::placeholder,.inp::-webkit-input-placeholder{color:#C8C4BB !important;font-style:italic !important;font-weight:300 !important;opacity:1 !important}
.ni::placeholder,.ni::-webkit-input-placeholder{font-size:13px !important}
.ni{text-align:center;font-weight:600;font-size:16px}
.lb{font-size:11px;color:#8A8A8A;font-weight:600;display:block;margin-bottom:4px}
.rw{display:flex;gap:8px;align-items:center}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sc{background:#fff;border-radius:14px;padding:14px;border:1px solid #E8E4DC;box-shadow:0 2px 12px rgba(0,0,0,.06)}
.db{display:flex;align-items:center;gap:12px;padding:14px;background:#fff;border:1.5px solid #E8E4DC;border-radius:14px;cursor:pointer;width:100%;text-align:left;margin-bottom:8px;font-family:inherit;font-size:14px}
.db.ac{background:#E8F2EF;border-color:#3B7A6B}
.tg{font-size:12px;padding:3px 8px;border-radius:8px;font-weight:600;display:inline-block}
.tok{background:#E8F5E9;color:#4CAF50}.twn{background:#FFF8E1;color:#D4A017}.tbd{background:#FDEAEA;color:#D94F4F}
.hd{background:linear-gradient(135deg,#3B7A6B,#2D6155);color:#fff;padding:24px 20px 20px;border-radius:0 0 24px 24px}
.sh{background:#3B7A6B;color:#fff;padding:16px 18px;display:flex;align-items:center;gap:12px}
.bb{background:none;border:none;color:#fff;font-size:22px;cursor:pointer;padding:8px;font-family:inherit}
.lb2{background:rgba(255,255,255,.2);border:none;color:#fff;padding:8px 14px;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit}
.mi{display:flex;align-items:center;padding:10px 12px;background:#FAFAF8;border-radius:10px;margin-bottom:6px;gap:10px}
.da{width:100%;padding:12px;border-radius:10px;border:2px dashed #E8E4DC;background:#FAFAF8;cursor:pointer;font-size:13px;color:#8A8A8A;margin-top:4px;font-family:inherit}
.al{background:#FDEAEA;border:2px solid #D94F4F;border-radius:14px;padding:16px;text-align:center;margin-bottom:14px}
.hd2{display:none}
.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#4CAF50;color:#fff;padding:8px 20px;border-radius:20px;font-size:13px;font-weight:600;z-index:200;opacity:0;transition:opacity .3s}
.toast.show{opacity:1}
canvas{display:block;margin:0 auto}
</style>
</head>
<body>
<div id="toast" class="toast">Saved âœ“</div>
<div id="app">Loading...</div>
<script>
"use strict";
var LS={g:function(k){try{return JSON.parse(localStorage.getItem(k))}catch(e){return null}},s:function(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}};
var data=LS.g("ht-d")||{},goals=LS.g("ht-g")||{},meds=LS.g("ht-m")||[],labs=LS.g("ht-lb")||[],lang=LS.g("ht-l")||"en",uname=LS.g("ht-n")||"";
var view="home",sel=td(),histMonth=new Date().getFullYear()+"-"+("0"+(new Date().getMonth()+1)).slice(-2),chartRange=30;

var L={en:{
app:"Health Tracker",hi:"Hi Mum & Dad \ud83e\udec0",hiN:"Hi {name} \ud83e\udec0",sub:"Track your health daily",log:"+ Log Today",
wk:"This Week",rec:"Recent Days",ref:"Quick Reference",
bp:"Blood Pressure",bpT:"Target: below 130/80 mmHg",mo:"Morning",ev:"Evening",sy:"Systolic",di:"Diastolic",
su:"Blood Sugar",suT:"Fasting: 4.4\u20137.2 \u00b7 Post-meal: <10.0 mmol/L",fa:"Fasting",pm:"Post-meal",
me:"Meals",bk:"Breakfast",lu:"Lunch",dn:"Dinner",sn:"Snacks",
ex:"Exercise",mn:"Minutes",ty:"Type",ql:"Quick Log",mt:"Medication taken",wt:"Weight",nt:"Notes",
wa:"Share via WhatsApp",wr:"\u26a0\ufe0f Reading outside safe range!",wM:"Please inform Shun Herng or visit a clinic.",
nd:"e.g. 120/80, 5.5",td:"Today",he:"Health Entry",pv:"\u25c0",nx:"\u25b6",
aB:"Avg BP",aS:"Avg Sugar",mL:"Meds",
bR:"BP Target",bl:"Below 130/80",fS:"Fasting Sugar",sR:"4.4\u20137.2 mmol/L",bW:"BP Warning",bWR:"140\u2013159/90\u201399",em:"Emergency",eR:"BP\u2265160 Sugar\u2265250",
wg:"Weekly Goal",sg:"Set this week's goal",gp:"e.g. Walk 15 min after dinner 3 days",ga:"Goal achieved!",md:"\u2713 Mark done",
bpTr:"BP Trend (14 days)",sTr:"Sugar Trend (14 days)",tr:"Trends",ncd:"Start logging to see trends",
ln:"\u4e2d\u6587",sv:"Save",cn:"Cancel",
meds:"Medications",addM:"+ Add medication",noM:"No medications added yet",
labs:"Lab Results",addL:"+ Add result",noL:"No lab results yet",
exp:"\ud83d\udcc4 Export for Clinic",mr:"More",sn2:"Your Name",snP:"e.g. Mum / Dad / Ah Ma",eb:"\ud83d\udce7 Email Backup to Shun Herng",
mp:{bk:"e.g. Roti canai + teh-O",lu:"e.g. Nasi + ikan bakar",dn:"e.g. Porridge + fish",sn:"e.g. Apple, nuts"},
ep:"e.g. Evening walk",ne:"No exercise today",exTr:"Exercise Trend",np:"Any notes...",
mPh:{n:"e.g. Amlodipine",d:"e.g. 5mg",f:"e.g. Once daily",t:"e.g. Morning"}
},zh:{
app:"\u5065\u5eb7\u8ffd\u8e2a\u5668",hi:"\u7238\u5988\u597d \ud83e\udec0",hiN:"{name} \u597d \ud83e\udec0",sub:"\u6bcf\u5929\u8bb0\u5f55\u5065\u5eb7\u72b6\u51b5",log:"+ \u8bb0\u5f55\u4eca\u5929",
wk:"\u672c\u5468",rec:"\u8fd1\u671f\u8bb0\u5f55",ref:"\u53c2\u8003\u6307\u6807",
bp:"\u8840\u538b",bpT:"\u76ee\u6807\uff1a\u4f4e\u4e8e130/80",mo:"\u65e9\u4e0a",ev:"\u665a\u4e0a",sy:"\u6536\u7f29\u538b",di:"\u8212\u5f20\u538b",
su:"\u8840\u7cd6",suT:"\u7a7a\u8179:4.4\u20137.2 \u00b7 \u9910\u540e:<10.0 mmol/L",fa:"\u7a7a\u8179",pm:"\u9910\u540e",
me:"\u996e\u98df",bk:"\u65e9\u9910",lu:"\u5348\u9910",dn:"\u665a\u9910",sn:"\u96f6\u98df",
ex:"\u8fd0\u52a8",mn:"\u5206\u949f",ty:"\u7c7b\u578b",ql:"\u5feb\u901f\u8bb0\u5f55",mt:"\u5df2\u670d\u836f",wt:"\u4f53\u91cd",nt:"\u5907\u6ce8",
wa:"\u901a\u8fc7WhatsApp\u5206\u4eab",wr:"\u26a0\ufe0f \u8bfb\u6570\u8d85\u51fa\u5b89\u5168\u8303\u56f4\uff01",wM:"\u8bf7\u901a\u77e5\u987a\u6052\u6216\u5230\u8bca\u6240\u5c31\u533b\u3002",
nd:"\u4f8b\uff1a120/80, 5.5",td:"\u4eca\u5929",he:"\u5065\u5eb7\u8bb0\u5f55",pv:"\u25c0",nx:"\u25b6",
aB:"\u5e73\u5747\u8840\u538b",aS:"\u5e73\u5747\u8840\u7cd6",mL:"\u670d\u836f",
bR:"\u8840\u538b\u76ee\u6807",bl:"\u4f4e\u4e8e130/80",fS:"\u7a7a\u8179\u8840\u7cd6",sR:"4.4\u20137.2",bW:"\u8840\u538b\u8b66\u544a",bWR:"140\u2013159/90\u201399",em:"\u7d27\u6025\u60c5\u51b5",eR:"\u8840\u538b\u2265160 \u8840\u7cd6\u226513.9",
wg:"\u6bcf\u5468\u76ee\u6807",sg:"\u8bbe\u5b9a\u672c\u5468\u76ee\u6807",gp:"\u4f8b\uff1a\u996d\u540e\u6563\u6b6515\u5206\u949f\uff0c\u4e00\u54683\u6b21",ga:"\u76ee\u6807\u8fbe\u6210\uff01",md:"\u2713 \u6807\u8bb0\u5b8c\u6210",
bpTr:"\u8840\u538b\u8d8b\u52bf (14\u5929)",sTr:"\u8840\u7cd6\u8d8b\u52bf (14\u5929)",tr:"\u8d8b\u52bf\u56fe",ncd:"\u5f00\u59cb\u8bb0\u5f55\u540e\u5373\u53ef\u67e5\u770b",
ln:"EN",sv:"\u4fdd\u5b58",cn:"\u53d6\u6d88",
meds:"\u836f\u7269\u6e05\u5355",addM:"+ \u6dfb\u52a0\u836f\u7269",noM:"\u5c1a\u672a\u6dfb\u52a0\u836f\u7269",
labs:"\u5316\u9a8c\u7ed3\u679c",addL:"+ \u6dfb\u52a0\u7ed3\u679c",noL:"\u5c1a\u65e0\u5316\u9a8c\u7ed3\u679c",
exp:"\ud83d\udcc4 \u5bfc\u51fa\u8bca\u6240\u62a5\u544a",mr:"\u66f4\u591a",sn2:"\u4f60\u7684\u540d\u5b57",snP:"\u4f8b\uff1a\u5988\u5988 / \u7238\u7238",eb:"\ud83d\udce7 \u53d1\u9001\u5907\u4efd\u7ed9\u987a\u6052",
mp:{bk:"\u4f8b\uff1a\u9762\u5305+\u5496\u5561\u4e4c",lu:"\u4f8b\uff1a\u767d\u996d+\u84b8\u9c7c",dn:"\u4f8b\uff1a\u7ca5+\u6e05\u84b8\u9c7c",sn:"\u4f8b\uff1a\u82f9\u679c\u3001\u575a\u679c"},
ep:"\u4f8b\uff1a\u665a\u996d\u540e\u6563\u6b65",ne:"\u4eca\u5929\u6ca1\u8fd0\u52a8",exTr:"\u8fd0\u52a8\u8d8b\u52bf",np:"\u5176\u4ed6\u5907\u6ce8...",
mPh:{n:"\u4f8b\uff1a\u6c28\u6c2f\u5730\u5e73",d:"\u4f8b\uff1a5mg",f:"\u4f8b\uff1a\u6bcf\u5929\u4e00\u6b21",t:"\u4f8b\uff1a\u65e9\u4e0a"}
}};

function T(){return L[lang]}
function td(){var d=new Date();return d.getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2)}
function fD(d){var lo=lang==="zh"?"zh-CN":"en-MY";return new Date(d+"T00:00:00").toLocaleDateString(lo,{weekday:"short",day:"numeric",month:"short"})}
function sD(d){var x=new Date(d+"T00:00:00");return x.getDate()+"/"+(x.getMonth()+1)}
function wK(){var x=new Date(),j=new Date(x.getFullYear(),0,1);return x.getFullYear()+"-W"+Math.ceil(((x-j)/864e5+j.getDay()+1)/7)}
function gL(n){var a=[];for(var i=n-1;i>=0;i--){var d=new Date();d.setDate(d.getDate()-i);a.push(d.getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2))}return a}
function eE(){return{bpMornSys:"",bpMornDia:"",bpEveSys:"",bpEveDia:"",fastingSugar:"",postMealSugar:"",breakfast:"",lunch:"",dinner:"",snacks:"",exerciseMin:"",exerciseType:"",medsTaken:false,weight:"",notes:""}}
function bpS(s){if(!s)return"";return s>=160?"bad":s>=130?"warn":"ok"}
function suS(v){if(!v)return"";return(v<3.9||v>=13.9)?"bad":v>=10.0?"warn":v<=7.2?"ok":"warn"}
function tc(s){return s==="ok"?"tok":s==="warn"?"twn":s==="bad"?"tbd":""}
function esc(s){if(!s)return"";return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}

function save(){LS.s("ht-d",data);LS.s("ht-g",goals);LS.s("ht-m",meds);LS.s("ht-lb",labs);LS.s("ht-l",lang);
  var t=document.getElementById("toast");t.classList.add("show");setTimeout(function(){t.classList.remove("show")},1000)}
function nav(v,d){view=v;if(d)sel=d;window.scrollTo({top:0,behavior:"smooth"});render()}
function upd(f,v){if(!data[sel])data[sel]=eE();data[sel][f]=v;save();render()}
function prevMo(){var p=histMonth.split("-"),y=+p[0],m=+p[1]-1;if(m<1){m=12;y--}histMonth=y+"-"+("0"+m).slice(-2);render()}
function nextMo(){var p=histMonth.split("-"),y=+p[0],m=+p[1]+1;if(m>12){m=1;y++}var mx=new Date().getFullYear()+"-"+("0"+(new Date().getMonth()+1)).slice(-2);var nx=y+"-"+("0"+m).slice(-2);if(nx<=mx)histMonth=nx;render()}
function moDays(ym){var p=ym.split("-"),y=+p[0],m=+p[1],n=new Date(y,m,0).getDate(),a=[];for(var i=n;i>=1;i--){var d=y+"-"+("0"+m).slice(-2)+"-"+("0"+i).slice(-2);if(d<=td())a.push(d)}return a}
function moLabel(ym){var p=ym.split("-");return new Date(+p[0],+p[1]-1,1).toLocaleDateString(lang==="zh"?"zh-CN":"en-MY",{year:"numeric",month:"long"})}
function togLang(){lang=lang==="en"?"zh":"en";save();render()}

// Canvas chart
function drawChart(id,datasets,refs){
  setTimeout(function(){
    var canvas=document.getElementById(id);if(!canvas)return;
    var ctx=canvas.getContext("2d");
    var W=canvas.parentElement.clientWidth-36;if(W<100)W=280;
    canvas.width=W*2;canvas.height=360;canvas.style.width=W+"px";canvas.style.height="180px";canvas.style.display="block";
    ctx.scale(2,2);var w=W,h=180,p={t:10,r:15,b:25,l:35};
    var cw=w-p.l-p.r,ch=h-p.t-p.b;
    var allV=[];
    for(var i=0;i<datasets.length;i++)for(var j=0;j<datasets[i].d.length;j++)if(datasets[i].d[j]!==null)allV.push(datasets[i].d[j]);
    for(i=0;i<refs.length;i++)allV.push(refs[i].y);
    if(!allV.length)return;
    var mn=Math.floor((Math.min.apply(null,allV)-10)/10)*10;
    var mx=Math.ceil((Math.max.apply(null,allV)+10)/10)*10;
    var rng=mx-mn||1;
    ctx.fillStyle="#fff";ctx.fillRect(0,0,w,h);
    ctx.strokeStyle="#F0EDE8";ctx.lineWidth=.5;
    for(i=0;i<=4;i++){var y=p.t+ch*(i/4);ctx.beginPath();ctx.moveTo(p.l,y);ctx.lineTo(w-p.r,y);ctx.stroke();
      ctx.fillStyle="#8A8A8A";ctx.font="9px sans-serif";ctx.textAlign="right";ctx.fillText(Math.round(mx-rng*(i/4)),p.l-4,y+3)}
    var lbs=datasets[0].labels;ctx.fillStyle="#8A8A8A";ctx.font="9px sans-serif";ctx.textAlign="center";
    var step=Math.max(1,Math.floor(lbs.length/5));
    for(i=0;i<lbs.length;i++)if(i%step===0||i===lbs.length-1)ctx.fillText(lbs[i],p.l+cw*(i/(lbs.length-1)),h-6);
    for(i=0;i<refs.length;i++){y=p.t+ch*(1-(refs[i].y-mn)/rng);ctx.strokeStyle=refs[i].c;ctx.lineWidth=1;ctx.setLineDash([5,4]);ctx.beginPath();ctx.moveTo(p.l,y);ctx.lineTo(w-p.r,y);ctx.stroke();ctx.setLineDash([])}
    for(i=0;i<datasets.length;i++){var ds=datasets[i],pts=[];
      for(j=0;j<ds.d.length;j++)if(ds.d[j]!==null)pts.push({x:p.l+cw*(j/(lbs.length-1)),y:p.t+ch*(1-(ds.d[j]-mn)/rng)});
      if(pts.length<2)continue;
      ctx.strokeStyle=ds.c;ctx.lineWidth=ds.da?1.5:2.5;if(ds.da)ctx.setLineDash([4,3]);else ctx.setLineDash([]);
      ctx.beginPath();for(j=0;j<pts.length;j++){if(j===0)ctx.moveTo(pts[j].x,pts[j].y);else ctx.lineTo(pts[j].x,pts[j].y)}ctx.stroke();ctx.setLineDash([]);
      if(!ds.da)for(j=0;j<pts.length;j++){ctx.beginPath();ctx.arc(pts[j].x,pts[j].y,3.5,0,Math.PI*2);ctx.fillStyle="#fff";ctx.fill();ctx.strokeStyle=ds.c;ctx.lineWidth=2;ctx.stroke()}}
  },300);
}

function waMsg(){
  var e=data[sel]||eE(),ds=fD(sel),n=[];
  n.push("\ud83d\udccb *Health \u2014 "+ds+"*","");
  if(e.bpMornSys)n.push("\u2764\ufe0f Morn BP: "+e.bpMornSys+"/"+e.bpMornDia);
  if(e.bpEveSys)n.push("\u2764\ufe0f Eve BP: "+e.bpEveSys+"/"+e.bpEveDia);
  if(e.fastingSugar)n.push("\ud83e\ude78 Fasting: "+e.fastingSugar+" mmol/L");
  if(e.postMealSugar)n.push("\ud83e\ude78 Post-meal: "+e.postMealSugar+" mmol/L");
  n.push("");
  if(e.breakfast)n.push("\ud83c\udf73 "+e.breakfast);
  if(e.lunch)n.push("\ud83c\udf5a "+e.lunch);
  if(e.dinner)n.push("\ud83c\udf7d\ufe0f "+e.dinner);
  n.push("");
  if(e.exerciseMin)n.push("\ud83d\udeb6 "+e.exerciseMin+"min");
  n.push("\ud83d\udc8a Meds: "+(e.medsTaken?"\u2705":"\u274c"));
  if(bpS(+e.bpMornSys)==="bad"||suS(+e.fastingSugar)==="bad")n.push("","\u26a0\ufe0f *WARNING*");
  return n.join("\n");
}

function doExport(){
  var c="HEALTH REPORT - "+new Date().toLocaleDateString()+"\n\nDate,Morning BP,Evening BP,Fasting Sugar(mmol/L),Post-meal Sugar(mmol/L),Exercise(min),Medication,Weight\n";
  var keys=Object.keys(data).sort().reverse();
  for(var i=0;i<keys.length;i++){var d=keys[i],e=data[d];
    c+=d+","+(e.bpMornSys?e.bpMornSys+"/"+e.bpMornDia:"")+","+(e.bpEveSys?e.bpEveSys+"/"+e.bpEveDia:"")+","+(e.fastingSugar||"")+","+(e.postMealSugar||"")+","+(e.exerciseMin||"")+","+(e.medsTaken?"Yes":"No")+","+(e.weight||"")+"\n"}
  c+="\nMEDICATIONS\nName,Dose,Frequency,Time\n";
  for(i=0;i<meds.length;i++)c+=meds[i].name+","+meds[i].dose+","+meds[i].freq+","+meds[i].time+"\n";
  c+="\nLAB RESULTS\nDate,HbA1c(%),Total Chol,LDL,HDL,TG\n";
  for(i=0;i<labs.length;i++){var l=labs[i];c+=l.date+","+(l.hba1c||"")+","+(l.chol||"")+","+(l.ldl||"")+","+(l.hdl||"")+","+(l.trig||"")+"\n"}
  var b=new Blob([c],{type:"text/csv"}),u=URL.createObjectURL(b),a=document.createElement("a");
  a.href=u;a.download="health-report-"+td()+".csv";a.click();URL.revokeObjectURL(u);
}

function emailBackup(){
  var subj="Health Tracker Backup - "+(uname||"Parent")+" - "+td();
  var body="HEALTH TRACKER BACKUP\n";
  body+="Name: "+(uname||"Parent")+"\nDate: "+new Date().toLocaleDateString()+"\n\n";
  body+="=== RECENT READINGS (Last 14 days) ===\n";
  var d14=gL(chartRange);
  for(var i=d14.length-1;i>=0;i--){var d=d14[i],e=data[d];if(!e)continue;
    body+=d+": ";
    if(e.bpMornSys)body+="BP "+e.bpMornSys+"/"+e.bpMornDia+" ";
    if(e.fastingSugar)body+="Sugar "+e.fastingSugar+" ";
    if(e.medsTaken)body+="Meds:Yes ";
    if(e.exerciseMin)body+="Ex:"+e.exerciseMin+"min ";
    body+="\n";}
  body+="\n=== MEDICATIONS ===\n";
  for(var i=0;i<meds.length;i++)body+=meds[i].name+" "+meds[i].dose+" "+meds[i].freq+"\n";
  body+="\n=== LAB RESULTS ===\n";
  for(var i=0;i<labs.length;i++){var l=labs[i];body+=l.date+": ";if(l.hba1c)body+="HbA1c:"+l.hba1c+"% ";if(l.chol)body+="Chol:"+l.chol+" ";if(l.ldl)body+="LDL:"+l.ldl+" ";body+="\n";}
  body+="\n=== FULL DATA (JSON) ===\n"+JSON.stringify({data:data,meds:meds,labs:labs,goals:goals});
  var em=LS.g("ht-email")||"";window.location.href="mailto:"+em+"?subject="+encodeURIComponent(subj)+"&body="+encodeURIComponent(body);
}

function syncToSheet(){
  var SHEET_URL=LS.g("ht-sheet")||"";
  if(!SHEET_URL){alert(lang==="zh"?"\u8bf7\u5148\u8bbe\u7f6eGoogle Sheets URL":"Please set Google Sheets URL first");return}
  var e=data[sel]||eE();
  var payload={name:uname||"Parent",date:sel,bpMornSys:e.bpMornSys,bpMornDia:e.bpMornDia,bpEveSys:e.bpEveSys,bpEveDia:e.bpEveDia,fastingSugar:e.fastingSugar,postMealSugar:e.postMealSugar,breakfast:e.breakfast,lunch:e.lunch,dinner:e.dinner,snacks:e.snacks,exerciseMin:e.exerciseMin,exerciseType:e.exerciseType,medsTaken:e.medsTaken?"Yes":"No",weight:e.weight,notes:e.notes};
  fetch(SHEET_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}).then(function(){
    var t=document.getElementById("toast");t.textContent="\u2601\ufe0f Synced!";t.classList.add("show");setTimeout(function(){t.classList.remove("show");t.textContent="Saved \u2713"},1500);
  }).catch(function(err){alert("Sync failed: "+err)});
}

function numInp(field,val,ph){
  var dec=field.indexOf("Sugar")>=0?"decimal":"numeric";
  var step=field.indexOf("Sugar")>=0?' step="0.1"':"";  
  return '<input type="number" inputmode="'+dec+'" '+step+' class="inp ni" value="'+esc(val)+'" placeholder="'+ph+'" oninput="upd(\''+field+'\',this.value)">';
}
function txtInp(field,val,ph){
  return '<input class="inp" value="'+esc(val)+'" placeholder="'+esc(ph)+'" oninput="upd(\''+field+'\',this.value)">';
}

function render(){
  var t=T(),el=document.getElementById("app"),e=data[sel]||eE();

  if(view==="entry"){
    var iT=sel===td(),hasD=e.bpMornSys||e.fastingSugar||e.medsTaken||e.breakfast;
    var isDn=bpS(+e.bpMornSys)==="bad"||bpS(+e.bpEveSys)==="bad"||suS(+e.fastingSugar)==="bad";
    var h='<div class="sh"><button class="bb" onclick="nav(\'home\')">\u2190</button><div style="flex:1"><div style="font-weight:800;font-size:17px">'+(iT?t.td:fD(sel))+'</div><div style="font-size:12px;opacity:.8">'+(iT?fD(sel):t.he)+'</div></div><button class="lb2" onclick="togLang()">'+t.ln+'</button></div>';
    var prevD=new Date(sel+"T00:00:00");prevD.setDate(prevD.getDate()-1);var prevS=prevD.getFullYear()+"-"+("0"+(prevD.getMonth()+1)).slice(-2)+"-"+("0"+prevD.getDate()).slice(-2);
    var nextD=new Date(sel+"T00:00:00");nextD.setDate(nextD.getDate()+1);var nextS=nextD.getFullYear()+"-"+("0"+(nextD.getMonth()+1)).slice(-2)+"-"+("0"+nextD.getDate()).slice(-2);var canNext=nextS<=td();
    h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 16px 0">';
    h+='<button onclick="nav(\'entry\',\''+prevS+'\')" style="padding:8px 16px;border-radius:10px;border:1px solid #E8E4DC;background:#fff;font-size:13px;color:#3B7A6B;cursor:pointer;font-family:inherit;font-weight:600">'+t.pv+' '+fD(prevS)+'</button>';
    if(canNext)h+='<button onclick="nav(\'entry\',\''+nextS+'\')" style="padding:8px 16px;border-radius:10px;border:1px solid #E8E4DC;background:#fff;font-size:13px;color:#3B7A6B;cursor:pointer;font-family:inherit;font-weight:600">'+fD(nextS)+' '+t.nx+'</button>';
    else h+='<div></div>';
    h+='</div>';
    h+='<div style="padding:12px 16px 16px">';
    // BP
    h+='<d
